{% extends "../base/base.html" %}
{% load crispy_forms_tags %}
{% block title %}Login{% endblock %}

{% block content %}
<form method="post" class="form-group">
    {% csrf_token %}
    {{ form|crispy }}

    <button type="submit" class="btn btn-success">Login</button>

    <p>
        Don't have an account?
        <a href="{% url 'signup' %}">Create one</a>
    </p>
</form>
{% endblock %}


<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');

    form.addEventListener('submit', async function(e) {
        // 1. Check the session status via AJAX
        const res = await fetch("{% url 'session_status' %}", { credentials: 'same-origin' });
        const data = await res.json();

        // 2. If already logged in from another tab, don't submit the form
        // Just take them to the landing page.
        if (data.logged_in) {
            e.preventDefault();
            window.location.href = "{% url 'main:team' %}";
            return;
        }

        // 3. If NOT logged in, let the form submit normally.
        // The browser will use the CSRF token currently in the HTML.
    });
});
</script>