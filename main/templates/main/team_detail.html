{% extends 'base/base.html' %}

{% block content %}
<hr>
<div class="container">
    <div class='d-flex justify-content-between align-items-center'>
        <h1>{{ team.title }}</h1>
            <a href='{% url 'main:team' %}' class='btn btn-secondary'>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16">
<path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"></path>
</svg>
            </a>
            </div>
    <p>Status: <strong>{{ team.get_status_display }}</strong></p>
    <p>Created by: {{ team.created_by.username }} on {{ team.created_at|date }}</p>

    <hr>

    <div class="row">
        <div class="col-md-4">
            <h3>Members</h3>
            <ul class="list-group">
                {% for mem in memberships %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ mem.user.username }}
                        <span class="badge bg-primary rounded-pill">{{ mem.role|title }}</span>
                    </li>
                {% endfor %}
            </ul>
            
            <div class = 'd-flex flex-column'>
                {% if my_role == 'supervisor' %}
                    <a href="#" 
                    class="btn btn-sm btn-outline-info mt-3" 
                    id="generate-invite-btn"
                    data-team-id="{{ team.id }}">
                    + Invite New Member
                    </a>
                {% endif %}

                {% comment %} <a href = "#" class = "btn btn-sm btn-outline-infor mt-3" id="add-task-btn">+ Add Task</a> {% endcomment %}
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-sm btn-primary mb-2" data-toggle="modal" data-target="#addTaskModal">
                    + Add Task
                </button>
                <button type="button" class="btn btn-sm btn-primary mb-2" data-toggle="modal" data-target="#viewAccomplishedTasksModal">
                    View Accomplished Tasks
                </button>
            </div>
        </div>

        <div class="col-md-8">
            <h3>Team Tasks</h3>
            <table class="table">
                <thead>
                    <tr>
                        {% if my_role == 'supervisor' %}
                            <th></th>
                        {% endif %}
                        <th class='align-middle'>Task ID</th>
                        <th class='align-middle'>Task</th>
                        <th class='align-middle'>Description</th>
                        <th class='align-middle'>Assigned To</th>
                        <th class='align-middle'>Status</th>
                        <th class='align-middle'>Deadline</th>
                        <th class='align-middle'>Priority Score</th>
                        {% if my_role == 'supervisor' %}
                            <th class='align-middle'>Accept Task?</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                        <tr>
                            {% if my_role == 'supervisor' %}
                                <td>
                                    <form action="{% url 'main:delete-task' task.task_id %}" method="POST" onsubmit="return confirm('Are you sure you want to delete this task?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-link text-danger p-0" title="Delete Task">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                                                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path>
                                            </svg>
                                        </button>
                                    </form>
                                </td>  
                            {% endif %}
                            <td>{{ task.task_id }}</td>
                            <td>{{ task.title }}</td>
                            <td style="max-width: 250px; word-wrap: break-word; white-space: normal;">{{ task.description }}</td>
                            <td>{{ task.assigned_to.username }}</td>
                            <td>{{ task.get_status_display }}</td>
                            <td>{{ task.deadline|date:"M d, Y" }}</td>
                            <td>{{ task.priority_score }}</td>
                            {% if my_role == 'supervisor' %}
                                <td>
                                    <div class="d-flex gap-1">
                                        <form action="{% url 'main:complete-task' task.task_id %}" method="POST" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn btn-sm btn-success" 
                                                    {% if task.status == 'pending' or task.status == 'revision' %}disabled{% endif %}
                                                    style="line-height: 1;"
                                                    title="Mark as Accomplished">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                                                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.42-6.448a.02.02 0 0 1 .032-.012z"/>
                                                </svg>
                                            </button>
                                        </form>

                                        <button type="button" 
                                                class="btn btn-sm btn-outline-danger" 
                                                {% if task.status == 'pending' or task.status == 'revision' %}disabled{% endif %}
                                                style="line-height: 1;" 
                                                data-toggle="modal" 
                                                data-target="#reviseTaskModal"
                                                data-taskid="{{ task.task_id }}"
                                                data-description="{{ task.description }}"
                                                data-deadline="{{ task.deadline|date:'Y-m-d\TH:i' }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            {% endif %}
                        </tr>
                    {% empty %}
                        <tr><td colspan="4">No tasks yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if tasks.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if tasks.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ tasks.previous_page_number }}">Previous</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">Previous</span></li>
                        {% endif %}

                        {% for i in tasks.paginator.page_range %}
                            {% if tasks.number == i %}
                                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                            {% else %}
                                <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if tasks.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ tasks.next_page_number }}">Next</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">Next</span></li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <form method="POST"> {% csrf_token %}
                <div class="modal-body">
                    {{ form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% comment %} REVISE TASK MODAL {% endcomment %}
<div class="modal fade" id="reviseTaskModal" tabindex="-1" aria-labelledby="reviseTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Revise & Reschedule Task</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="reviseTaskForm" method="POST" action="">
          {% csrf_token %}
          <div class="modal-body">
              <div class="form-group mb-3">
                  <label for="modal-description">Revised Task Description/Notes:</label>
                  <textarea class="form-control" id="revise-modal-description" name="description" rows="4" maxlength='120' required></textarea>
                  <small id="revise-char-count" class="form-text text-muted">120 characters remaining</small>
              </div>
              
              <div class="form-group">
                  <label for="modal-deadline">Adjust Deadline:</label>
                  <input type="datetime-local" class="form-control" id="revise-modal-deadline" name="deadline" required>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Return for Revision</button>
          </div>
      </form>
    </div>
  </div>
</div>

{% comment %} VIEW ACCOMPLISHED TASKS ON TEAM {% endcomment %}
<div class="modal fade" id="viewAccomplishedTasksModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Accomplished Tasks ({{ team.title }})</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        {% if my_role == 'supervisor' and acc_stack %}
        <div class="card mb-3 border-danger">
            <div class="card-body py-2">
                <h6 class="card-title text-danger">Supervisor Stack Controls</h6>
                <form action="{% url 'main:bulk-delete-acc' team.id %}" method="POST" class="row g-2 align-items-center">
                    {% csrf_token %}
                    <div class="col-auto">
                        <select name="delete_type" id="delete_type" class="form-select form-select-sm" onchange="toggleNumInput(this)">
                            <option value="count">Delete Top N</option>
                            <option value="all">Clear All History</option>
                        </select>
                    </div>
                    <div class="col-auto" id="num_input_container">
                        <input type="number" name="num_to_delete" class="form-control form-control-sm" placeholder="Qty" min="1" max="{{ acc_stack.paginator.count }}">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Confirm bulk deletion?')">Execute</button>
                    </div>
                </form>
            </div>
        </div>
        <hr>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Description</th>
                        <th>Finished</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in acc_stack %} 
                    <tr>
                        <td><strong>{{ task.title }}</strong></td>
                        <td>{{ task.description }}</td>
                        <td><small>{{ task.updated_at|date:"M d" }}</small></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center">No tasks completed yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if acc_tasks.has_other_pages %}
            <nav>
                <ul class="pagination pagination-sm justify-content-center">
                    {% if acc_tasks.has_previous %}
                        <li class="page-item"><a class="page-link" href="?acc_page={{ acc_tasks.previous_page_number }}&page={{ tasks.number }}&show_modal=true">Prev</a></li>
                    {% endif %}

                    <li class="page-item disabled"><span class="page-link">Page {{ acc_tasks.number }} of {{ acc_tasks.paginator.num_pages }}</span></li>

                    {% if acc_tasks.has_next %}
                        <li class="page-item"><a class="page-link" href="?acc_page={{ acc_tasks.next_page_number }}&page={{ tasks.number }}&show_modal=true">Next</a></li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('generate-invite-btn');

    btn.addEventListener('click', function(e) {
        e.preventDefault(); // prevent default link behavior
        const teamId = btn.dataset.teamId;

        fetch(`/main/team/${teamId}/invite/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if(data.error) {
                alert(data.error);
                return;
            }

            const code = data.invite_code;

            // Copy to clipboard
            navigator.clipboard.writeText(code).then(() => {
                alert(`Invite code copied to clipboard: ${code}`);
            }).catch(err => {
                alert(`Failed to copy invite code. Code: ${code}`);
            });
        })
        .catch(err => {
            alert('Error generating invite code.');
            console.error(err);
        });
    });
});

$('#reviseTaskModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var taskId = button.data('taskid'); 
    var description = button.data('description'); 
    var deadline = button.data('deadline');

    var modal = $(this);
    
    // Dynamically set the form action to your revise_task view
    modal.find('#reviseTaskForm').attr('action', '/main/task/' + taskId + '/revise/');
    
    // Populate fields
    modal.find('#revise-modal-description').val(description);
    modal.find('#revise-modal-deadline').val(deadline);
    
    // Update counter
    const remaining = 120 - (description ? description.length : 0);
    document.getElementById('revise-char-count').textContent = `${remaining} characters remaining`;
});

// Counter listener for the revision textarea
document.getElementById('revise-modal-description').addEventListener('input', function() {
    const remaining = 120 - this.value.length;
    document.getElementById('revise-char-count').textContent = `${remaining} characters remaining`;
});

document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('show_modal') === 'true') {
            // Re-opens the modal using Bootstrap's jQuery method
            $('#viewAccomplishedTasksModal').modal('show');
        }
    });

function toggleNumInput(select) {
    const container = document.getElementById('num_input_container');
    if (select.value === 'all') {
        container.style.visibility = 'hidden';
    } else {
        container.style.visibility = 'visible';
    }
}
</script>
{% endblock %}

